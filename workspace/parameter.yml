# parameter.yml — fabric-cicd environment parameterisation
# Principle II: Contains secret *names* only (Key Vault URLs + key names). No secret values.
# Principle VIII: Enables environment-specific deployment without hardcoded strings.
#
# Supported operations:
#   find_replace      — regex or literal string substitution across all item files
#   key_value_replace — JSONPath key-based substitution (pipeline JSON, notebook metadata)
#   spark_pool        — replaces instance_pool_id in Setting/Sparkcompute.yml

DEV:
  find_replace:
    # Lakehouse GUID — substituted into # META default_lakehouse fields in notebooks
    - find_value: "00000000-0000-0000-0000-000000000000"
      replace_value: "$items.Lakehouse.CopilotUsageLakehouse.$id"
      item_type: "Notebook"
      file_path: "notebook-content.py"

    # Lakehouse workspace GUID — substituted into # META default_lakehouse_workspace_id
    - find_value: "11111111-1111-1111-1111-111111111111"
      replace_value: "$workspace.$id"
      item_type: "Notebook"
      file_path: "notebook-content.py"

    # Key Vault URL — substituted in all notebook files
    - find_value: "https://kv-copilot-dev.vault.azure.net"
      replace_value: "https://kv-copilot-dev.vault.azure.net"
      item_type: "Notebook"
      file_path: "notebook-content.py"

  key_value_replace:
    # Notebook references in pipeline — resolved to deployed item GUIDs at runtime
    - find_key: "typeProperties.notebookId"
      replace_value:
        "00_watermarks": "$items.Notebook.00_watermarks.$id"
        "01_ingest_users": "$items.Notebook.01_ingest_users.$id"
        "02_ingest_usage": "$items.Notebook.02_ingest_usage.$id"
        "03_ingest_audit_logs": "$items.Notebook.03_ingest_audit_logs.$id"
        "04_transform_silver": "$items.Notebook.04_transform_silver.$id"
        "05_transform_gold": "$items.Notebook.05_transform_gold.$id"
        "06_compute_scores": "$items.Notebook.06_compute_scores.$id"
        "99_dq_checks": "$items.Notebook.99_dq_checks.$id"
      item_type: "DataPipeline"
      file_path: "pipeline-content.json"

    # Daily schedule disabled in DEV
    - find_key: "$.schedules[*].enabled"
      replace_value: "false"
      item_type: "DataPipeline"
      file_path: "pipeline-content.json"

PROD:
  find_replace:
    # Lakehouse GUID — same token, fabric-cicd resolves against PROD workspace
    - find_value: "00000000-0000-0000-0000-000000000000"
      replace_value: "$items.Lakehouse.CopilotUsageLakehouse.$id"
      item_type: "Notebook"
      file_path: "notebook-content.py"

    # Lakehouse workspace GUID
    - find_value: "11111111-1111-1111-1111-111111111111"
      replace_value: "$workspace.$id"
      item_type: "Notebook"
      file_path: "notebook-content.py"

    # Key Vault URL — PROD vault
    - find_value: "https://kv-copilot-dev.vault.azure.net"
      replace_value: "https://kv-copilot-prod.vault.azure.net"
      item_type: "Notebook"
      file_path: "notebook-content.py"

  key_value_replace:
    # Notebook references in pipeline
    - find_key: "typeProperties.notebookId"
      replace_value:
        "00_watermarks": "$items.Notebook.00_watermarks.$id"
        "01_ingest_users": "$items.Notebook.01_ingest_users.$id"
        "02_ingest_usage": "$items.Notebook.02_ingest_usage.$id"
        "03_ingest_audit_logs": "$items.Notebook.03_ingest_audit_logs.$id"
        "04_transform_silver": "$items.Notebook.04_transform_silver.$id"
        "05_transform_gold": "$items.Notebook.05_transform_gold.$id"
        "06_compute_scores": "$items.Notebook.06_compute_scores.$id"
        "99_dq_checks": "$items.Notebook.99_dq_checks.$id"
      item_type: "DataPipeline"
      file_path: "pipeline-content.json"

    # Daily schedule enabled in PROD
    - find_key: "$.schedules[*].enabled"
      replace_value: "true"
      item_type: "DataPipeline"
      file_path: "pipeline-content.json"
